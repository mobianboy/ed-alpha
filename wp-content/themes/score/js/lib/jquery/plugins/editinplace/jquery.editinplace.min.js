/*

A jQuery edit in place plugin

Version 2.3.0

Authors:
	Dave Hauenstein
	Martin HÃ¤cker <spamfaenger [at] gmx [dot] de>

Project home:
	http://code.google.com/p/jquery-in-place-editor/

Patches with tests welcomed! For guidance see the tests  </spec/unit/>. To submit, attach them to the bug tracker.

License:
This source file is subject to the BSD license bundled with this package.
Available online: {@link http://www.opensource.org/licenses/bsd-license.php}
If you did not receive a copy of the license, and are unable to obtain it, 
learn to use a search engine.

*/(function(e){function n(e,t){this.settings=e,this.dom=t,this.originalValue=null,this.didInsertDefaultText=!1,this.shouldDelayReinit=!1}function r(e){if(e.url||e.callback)return;throw new Error("Need to set either url: or callback: option for the inline editor to work.")}function i(e){if(""===e)return;var t=new Image;t.src=e}function s(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function o(e){return undefined===e||null===e?!1:0===e.length?!1:!0}e.fn.editInPlace=function(t){var s=e.extend({},e.fn.editInPlace.defaults,t);return r(s),i(s.saving_image),this.each(function(){var t=e(this);if(t.data("editInPlace"))return;t.data("editInPlace",!0),(new n(s,t)).init()})},e.fn.editInPlace.defaults={url:"",bg_over:"#ffc",bg_out:"transparent",hover_class:"",show_buttons:!1,save_button:'<button class="inplace_save">Save</button>',cancel_button:'<button class="inplace_cancel">Cancel</button>',params:"",field_type:"text",default_text:"(Click here to add text)",use_html:!1,textarea_rows:10,textarea_cols:25,select_text:"Choose new value",select_options:"",text_size:null,saving_text:undefined,saving_image:"",saving_animation_color:"transparent",value_required:!1,element_id:"element_id",update_value:"update_value",original_value:"original_value",original_html:"original_html",save_if_nothing_changed:!1,on_blur:"save",cancel:"",callback:null,callback_skip_dom_reset:!1,success:null,error:null,error_sink:function(e,t){alert(t)},preinit:null,postclose:null,delegate:null};var t={shouldOpenEditInPlace:function(e,t,n){},willOpenEditInPlace:function(e,t){},didOpenEditInPlace:function(e,t){},shouldCloseEditInPlace:function(e,t,n){},willCloseEditInPlace:function(e,t){},didCloseEditInPlace:function(e,t){},missingCommaErrorPreventer:""};e.extend(n.prototype,{init:function(){this.setDefaultTextIfNeccessary(),this.connectOpeningEvents()},reinit:function(){if(this.shouldDelayReinit)return;this.triggerCallback(this.settings.postclose,this.dom),this.triggerDelegateCall("didCloseEditInPlace"),this.markEditorAsInactive(),this.connectOpeningEvents()},setDefaultTextIfNeccessary:function(){if(""!==this.dom.html())return;this.dom.html(this.settings.default_text),this.didInsertDefaultText=!0},connectOpeningEvents:function(){var e=this;this.dom.bind("mouseenter.editInPlace",function(){e.addHoverEffect()}).bind("mouseleave.editInPlace",function(){e.removeHoverEffect()}).bind("click.editInPlace",function(t){e.openEditor(t)})},disconnectOpeningEvents:function(){this.dom.unbind(".editInPlace")},addHoverEffect:function(){this.settings.hover_class?this.dom.addClass(this.settings.hover_class):this.dom.css("background-color",this.settings.bg_over)},removeHoverEffect:function(){this.settings.hover_class?this.dom.removeClass(this.settings.hover_class):this.dom.css("background-color",this.settings.bg_out)},openEditor:function(e){if(!this.shouldOpenEditor(e))return;this.disconnectOpeningEvents(),this.removeHoverEffect(),this.removeInsertedDefaultTextIfNeccessary(),this.saveOriginalValue(),this.markEditorAsActive(),this.replaceContentWithEditor(),this.setInitialValue(),this.workAroundMissingBlurBug(),this.connectClosingEventsToEditor(),this.triggerDelegateCall("didOpenEditInPlace")},shouldOpenEditor:function(e){return this.isClickedObjectCancelled(e.target)?!1:!1===this.triggerCallback(this.settings.preinit,this.dom)?!1:!1===this.triggerDelegateCall("shouldOpenEditInPlace",!0,e)?!1:!0},removeInsertedDefaultTextIfNeccessary:function(){if(!this.didInsertDefaultText||this.dom.html()!==this.settings.default_text)return;this.dom.html(""),this.didInsertDefaultText=!1},isClickedObjectCancelled:function(t){if(!this.settings.cancel)return!1;var n=e(t).parents().andSelf(),r=n.filter(this.settings.cancel);return 0!==r.length},saveOriginalValue:function(){this.settings.use_html?this.originalValue=this.dom.html():this.originalValue=s(this.dom.text())},restoreOriginalValue:function(){this.setClosedEditorContent(this.originalValue)},setClosedEditorContent:function(e){this.settings.use_html?this.dom.html(e):this.dom.text(e)},workAroundMissingBlurBug:function(){var e=this.dom.find(":input");this.dom.parents(":last").find(".editInPlace-active :input").not(e).blur()},replaceContentWithEditor:function(){var e=this.settings.show_buttons?this.settings.save_button+" "+this.settings.cancel_button:"",t=this.createEditorElement();this.dom.html('<form class="inplace_form" style="display: inline; margin: 0; padding: 0;"></form>').find("form").append(t).append(e)},createEditorElement:function(){if(-1===e.inArray(this.settings.field_type,["text","textarea","select"]))throw"Unknown field_type <fnord>, supported are 'text', 'textarea' and 'select'";var t=null;return"select"===this.settings.field_type?t=this.createSelectEditor():"text"===this.settings.field_type?t=e('<input type="text" '+this.inputNameAndClass()+' size="'+this.settings.text_size+'" />'):"textarea"===this.settings.field_type&&(t=e("<textarea "+this.inputNameAndClass()+' rows="'+this.settings.textarea_rows+'" '+' cols="'+this.settings.textarea_cols+'" />')),t},setInitialValue:function(){var e=this.triggerDelegateCall("willOpenEditInPlace",this.originalValue),t=this.dom.find(":input");t.val(e),t.val()!==e&&t.val("")},inputNameAndClass:function(){return' name="inplace_value" class="inplace_field" '},createSelectEditor:function(){var t=e("<select"+this.inputNameAndClass()+">"+'<option disabled="true" value="">'+this.settings.select_text+"</option>"+"</select>"),n=this.settings.select_options;e.isArray(n)||(n=n.split(","));for(var r=0;r<n.length;r++){var i=n[r];e.isArray(i)||(i=i.split(":"));var o=s(i[1]||i[0]),u=s(i[0]),a=e("<option>").val(o).text(u);t.append(a)}return t},connectClosingEventsToEditor:function(){function n(e){return t.handleCancelEditor(e),!1}function r(e){return t.handleSaveEditor(e),!1}var t=this,i=this.dom.find("form");i.find(".inplace_field").focus().select(),i.find(".inplace_cancel").click(n),i.find(".inplace_save").click(r),this.settings.show_buttons||("save"===this.settings.on_blur?i.find(".inplace_field").blur(r):i.find(".inplace_field").blur(n),(e.browser.mozilla||e.browser.msie)&&this.bindSubmitOnEnterInInput()),i.keyup(function(e){var t=27;if(t===e.which)return n()}),e.browser.safari&&this.bindSubmitOnEnterInInput(),i.submit(r)},bindSubmitOnEnterInInput:function(){if("textarea"===this.settings.field_type)return;var e=this;this.dom.find(":input").keyup(function(t){var n=13;if(n===t.which)return e.dom.find("form").submit()})},handleCancelEditor:function(e){if(!1===this.triggerDelegateCall("shouldCloseEditInPlace",!0,e))return;var t=this.dom.find(":input").val();t=this.triggerDelegateCall("willCloseEditInPlace",t),this.restoreOriginalValue(),o(t)&&!this.isDisabledDefaultSelectChoice()&&this.setClosedEditorContent(t),this.reinit()},handleSaveEditor:function(e){if(!1===this.triggerDelegateCall("shouldCloseEditInPlace",!0,e))return;var t=this.dom.find(":input").val();t=this.triggerDelegateCall("willCloseEditInPlace",t);if(this.isDisabledDefaultSelectChoice()||this.isUnchangedInput(t)){this.handleCancelEditor(e);return}if(this.didForgetRequiredText(t)){this.handleCancelEditor(e),this.reportError("Error: You must enter a value to save this field");return}this.showSaving(t),this.settings.callback?this.handleSubmitToCallback(t):this.handleSubmitToServer(t)},didForgetRequiredText:function(e){return this.settings.value_required&&(""===e||undefined===e||null===e)},isDisabledDefaultSelectChoice:function(){return this.dom.find("option").eq(0).is(":selected:disabled")},isUnchangedInput:function(e){return!this.settings.save_if_nothing_changed&&this.originalValue===e},showSaving:function(t){if(this.settings.callback&&this.settings.callback_skip_dom_reset)return;var n=t;o(this.settings.saving_text)&&(n=this.settings.saving_text),o(this.settings.saving_image)&&(n=e("<img />").attr("src",this.settings.saving_image).attr("alt",n)),this.dom.html(n)},handleSubmitToCallback:function(e){this.enableOrDisableAnimationCallbacks(!0,!1);var t=this.triggerCallback(this.settings.callback,this.id(),e,this.originalValue,this.settings.params,this.savingAnimationCallbacks());this.settings.callback_skip_dom_reset||(undefined===t?(this.reportError("Error: Failed to save value: "+e),this.restoreOriginalValue()):this.dom.html(t)),this.didCallNoCallbacks()&&(this.enableOrDisableAnimationCallbacks(!1,!1),this.reinit())},handleSubmitToServer:function(t){var n=this.settings.update_value+"="+encodeURIComponent(t)+"&"+this.settings.element_id+"="+this.dom.attr("id")+(this.settings.params?"&"+this.settings.params:"")+"&"+this.settings.original_html+"="+encodeURIComponent(this.originalValue)+"&"+this.settings.original_value+"="+encodeURIComponent(this.originalValue);this.enableOrDisableAnimationCallbacks(!0,!1),this.didStartSaving();var r=this;e.ajax({url:r.settings.url,type:"POST",data:n,dataType:"html",complete:function(e){r.didEndSaving()},success:function(e){var t=e||r.settings.default_text;r.dom.html(t),r.triggerCallback(r.settings.success,e)},error:function(e){r.dom.html(r.originalHTML),r.settings.error?r.triggerCallback(r.settings.error,e):r.reportError("Failed to save value: "+e.responseText||"Unspecified Error")}})},triggerCallback:function(e){if(!e)return;var t=Array.prototype.slice.call(arguments,1);return e.apply(this.dom[0],t)},triggerDelegateCall:function(t,n,r){if(!this.settings.delegate||!e.isFunction(this.settings.delegate[t]))return n;var i=this.settings.delegate[t](this.dom,this.settings,r);return undefined===i?n:i},reportError:function(e){this.triggerCallback(this.settings.error_sink,this.id(),e)},id:function(){return this.dom.attr("id")},markEditorAsActive:function(){this.dom.addClass("editInPlace-active")},markEditorAsInactive:function(){this.dom.removeClass("editInPlace-active")},savingAnimationCallbacks:function(){var e=this;return{didStartSaving:function(){e.didStartSaving()},didEndSaving:function(){e.didEndSaving()}}},enableOrDisableAnimationCallbacks:function(e,t){this.didStartSaving.enabled=e,this.didEndSaving.enabled=t},didCallNoCallbacks:function(){return this.didStartSaving.enabled&&!this.didEndSaving.enabled},assertCanCall:function(e){if(!this[e].enabled)throw new Error("Cannot call "+e+" now. See documentation for details.")},didStartSaving:function(){this.assertCanCall("didStartSaving"),this.shouldDelayReinit=!0,this.enableOrDisableAnimationCallbacks(!1,!0),this.startSavingAnimation()},didEndSaving:function(){this.assertCanCall("didEndSaving"),this.shouldDelayReinit=!1,this.enableOrDisableAnimationCallbacks(!1,!1),this.reinit(),this.stopSavingAnimation()},startSavingAnimation:function(){var e=this;this.dom.animate({backgroundColor:this.settings.saving_animation_color},400).animate({backgroundColor:"transparent"},400,"swing",function(){setTimeout(function(){e.startSavingAnimation()},10)})},stopSavingAnimation:function(){this.dom.stop(!0).css({backgroundColor:""})},missingCommaErrorPreventer:""})})(jQuery);