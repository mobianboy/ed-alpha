/*!
 * jQuery MotionCAPTCHA v0.2
 * 
 * Proof of concept only for now, check the roadmap to see when it will be ready for wider use!
 * 
 * http://josscrowcroft.com/projects/motioncaptcha-jquery-plugin/
 * 
 * DEMO: http://josscrowcroft.com/demos/motioncaptcha/
 * CODE: https://github.com/josscrowcroft/MotionCAPTCHA
 * 
 * Copyright (c) 2011 Joss Crowcroft - joss[at]josscrowcroftcom | http://www.josscrowcroft.com
 * 
 * Incoporates other open source projects, attributed below.
 */
jQuery.fn.motionCaptcha||function(e){function t(e){this.init(e)}function n(e,t){this.X=e,this.Y=t}function r(e,t){return new n(e,t)}function i(e,t,n,r){this.X=e,this.Y=t,this.Width=n,this.Height=r}function s(e,t){this.Name=e,this.Points=h(t,a);var n=p(this.Points);this.Points=d(this.Points,-n),this.Points=v(this.Points,f),this.Points=m(this.Points,l),this.Vector=g(this.Points)}function o(e,t){this.Name=e,this.Score=t}function c(){this.Templates=[],this.Templates.push(new s("triangle",[r(137,139),r(135,141),r(133,144),r(132,146),r(130,149),r(128,151),r(126,155),r(123,160),r(120,166),r(116,171),r(112,177),r(107,183),r(102,188),r(100,191),r(95,195),r(90,199),r(86,203),r(82,206),r(80,209),r(75,213),r(73,213),r(70,216),r(67,219),r(64,221),r(61,223),r(60,225),r(62,226),r(65,225),r(67,226),r(74,226),r(77,227),r(85,229),r(91,230),r(99,231),r(108,232),r(116,233),r(125,233),r(134,234),r(145,233),r(153,232),r(160,233),r(170,234),r(177,235),r(179,236),r(186,237),r(193,238),r(198,239),r(200,237),r(202,239),r(204,238),r(206,234),r(205,230),r(202,222),r(197,216),r(192,207),r(186,198),r(179,189),r(174,183),r(170,178),r(164,171),r(161,168),r(154,160),r(148,155),r(143,150),r(138,148),r(136,148)])),this.Templates.push(new s("x",[r(87,142),r(89,145),r(91,148),r(93,151),r(96,155),r(98,157),r(100,160),r(102,162),r(106,167),r(108,169),r(110,171),r(115,177),r(119,183),r(123,189),r(127,193),r(129,196),r(133,200),r(137,206),r(140,209),r(143,212),r(146,215),r(151,220),r(153,222),r(155,223),r(157,225),r(158,223),r(157,218),r(155,211),r(154,208),r(152,200),r(150,189),r(148,179),r(147,170),r(147,158),r(147,148),r(147,141),r(147,136),r(144,135),r(142,137),r(140,139),r(135,145),r(131,152),r(124,163),r(116,177),r(108,191),r(100,206),r(94,217),r(91,222),r(89,225),r(87,226),r(87,224)])),this.Templates.push(new s("rectangle",[r(78,149),r(78,153),r(78,157),r(78,160),r(79,162),r(79,164),r(79,167),r(79,169),r(79,173),r(79,178),r(79,183),r(80,189),r(80,193),r(80,198),r(80,202),r(81,208),r(81,210),r(81,216),r(82,222),r(82,224),r(82,227),r(83,229),r(83,231),r(85,230),r(88,232),r(90,233),r(92,232),r(94,233),r(99,232),r(102,233),r(106,233),r(109,234),r(117,235),r(123,236),r(126,236),r(135,237),r(142,238),r(145,238),r(152,238),r(154,239),r(165,238),r(174,237),r(179,236),r(186,235),r(191,235),r(195,233),r(197,233),r(200,233),r(201,235),r(201,233),r(199,231),r(198,226),r(198,220),r(196,207),r(195,195),r(195,181),r(195,173),r(195,163),r(194,155),r(192,145),r(192,143),r(192,138),r(191,135),r(191,133),r(191,130),r(190,128),r(188,129),r(186,129),r(181,132),r(173,131),r(162,131),r(151,132),r(149,132),r(138,132),r(136,132),r(122,131),r(120,131),r(109,130),r(107,130),r(90,132),r(81,133),r(76,133)])),this.Templates.push(new s("circle",[r(127,141),r(124,140),r(120,139),r(118,139),r(116,139),r(111,140),r(109,141),r(104,144),r(100,147),r(96,152),r(93,157),r(90,163),r(87,169),r(85,175),r(83,181),r(82,190),r(82,195),r(83,200),r(84,205),r(88,213),r(91,216),r(96,219),r(103,222),r(108,224),r(111,224),r(120,224),r(133,223),r(142,222),r(152,218),r(160,214),r(167,210),r(173,204),r(178,198),r(179,196),r(182,188),r(182,177),r(178,167),r(170,150),r(163,138),r(152,130),r(143,129),r(140,131),r(129,136),r(126,139)])),this.Templates.push(new s("check",[r(91,185),r(93,185),r(95,185),r(97,185),r(100,188),r(102,189),r(104,190),r(106,193),r(108,195),r(110,198),r(112,201),r(114,204),r(115,207),r(117,210),r(118,212),r(120,214),r(121,217),r(122,219),r(123,222),r(124,224),r(126,226),r(127,229),r(129,231),r(130,233),r(129,231),r(129,228),r(129,226),r(129,224),r(129,221),r(129,218),r(129,212),r(129,208),r(130,198),r(132,189),r(134,182),r(137,173),r(143,164),r(147,157),r(151,151),r(155,144),r(161,137),r(165,131),r(171,122),r(174,118),r(176,114),r(177,112),r(177,114),r(175,116),r(173,118)])),this.Templates.push(new s("caret",[r(79,245),r(79,242),r(79,239),r(80,237),r(80,234),r(81,232),r(82,230),r(84,224),r(86,220),r(86,218),r(87,216),r(88,213),r(90,207),r(91,202),r(92,200),r(93,194),r(94,192),r(96,189),r(97,186),r(100,179),r(102,173),r(105,165),r(107,160),r(109,158),r(112,151),r(115,144),r(117,139),r(119,136),r(119,134),r(120,132),r(121,129),r(122,127),r(124,125),r(126,124),r(129,125),r(131,127),r(132,130),r(136,139),r(141,154),r(145,166),r(151,182),r(156,193),r(157,196),r(161,209),r(162,211),r(167,223),r(169,229),r(170,231),r(173,237),r(176,242),r(177,244),r(179,250),r(181,255),r(182,257)])),this.Templates.push(new s("zigzag",[r(307,216),r(333,186),r(356,215),r(375,186),r(399,216),r(418,186)])),this.Templates.push(new s("arrow",[r(68,222),r(70,220),r(73,218),r(75,217),r(77,215),r(80,213),r(82,212),r(84,210),r(87,209),r(89,208),r(92,206),r(95,204),r(101,201),r(106,198),r(112,194),r(118,191),r(124,187),r(127,186),r(132,183),r(138,181),r(141,180),r(146,178),r(154,173),r(159,171),r(161,170),r(166,167),r(168,167),r(171,166),r(174,164),r(177,162),r(180,160),r(182,158),r(183,156),r(181,154),r(178,153),r(171,153),r(164,153),r(160,153),r(150,154),r(147,155),r(141,157),r(137,158),r(135,158),r(137,158),r(140,157),r(143,156),r(151,154),r(160,152),r(170,149),r(179,147),r(185,145),r(192,144),r(196,144),r(198,144),r(200,144),r(201,147),r(199,149),r(194,157),r(191,160),r(186,167),r(180,176),r(177,179),r(171,187),r(169,189),r(165,194),r(164,196)])),this.Templates.push(new s("leftbracket",[r(140,124),r(138,123),r(135,122),r(133,123),r(130,123),r(128,124),r(125,125),r(122,124),r(120,124),r(118,124),r(116,125),r(113,125),r(111,125),r(108,124),r(106,125),r(104,125),r(102,124),r(100,123),r(98,123),r(95,124),r(93,123),r(90,124),r(88,124),r(85,125),r(83,126),r(81,127),r(81,129),r(82,131),r(82,134),r(83,138),r(84,141),r(84,144),r(85,148),r(85,151),r(86,156),r(86,160),r(86,164),r(86,168),r(87,171),r(87,175),r(87,179),r(87,182),r(87,186),r(88,188),r(88,195),r(88,198),r(88,201),r(88,207),r(89,211),r(89,213),r(89,217),r(89,222),r(88,225),r(88,229),r(88,231),r(88,233),r(88,235),r(89,237),r(89,240),r(89,242),r(91,241),r(94,241),r(96,240),r(98,239),r(105,240),r(109,240),r(113,239),r(116,240),r(121,239),r(130,240),r(136,237),r(139,237),r(144,238),r(151,237),r(157,236),r(159,237)])),this.Templates.push(new s("rightbracket",[r(112,138),r(112,136),r(115,136),r(118,137),r(120,136),r(123,136),r(125,136),r(128,136),r(131,136),r(134,135),r(137,135),r(140,134),r(143,133),r(145,132),r(147,132),r(149,132),r(152,132),r(153,134),r(154,137),r(155,141),r(156,144),r(157,152),r(158,161),r(160,170),r(162,182),r(164,192),r(166,200),r(167,209),r(168,214),r(168,216),r(169,221),r(169,223),r(169,228),r(169,231),r(166,233),r(164,234),r(161,235),r(155,236),r(147,235),r(140,233),r(131,233),r(124,233),r(117,235),r(114,238),r(112,238)])),this.Templates.push(new s("v",[r(89,164),r(90,162),r(92,162),r(94,164),r(95,166),r(96,169),r(97,171),r(99,175),r(101,178),r(103,182),r(106,189),r(108,194),r(111,199),r(114,204),r(117,209),r(119,214),r(122,218),r(124,222),r(126,225),r(128,228),r(130,229),r(133,233),r(134,236),r(136,239),r(138,240),r(139,242),r(140,244),r(142,242),r(142,240),r(142,237),r(143,235),r(143,233),r(145,229),r(146,226),r(148,217),r(149,208),r(149,205),r(151,196),r(151,193),r(153,182),r(155,172),r(157,165),r(159,160),r(162,155),r(164,150),r(165,148),r(166,146)])),this.Templates.push(new s("delete",[r(123,129),r(123,131),r(124,133),r(125,136),r(127,140),r(129,142),r(133,148),r(137,154),r(143,158),r(145,161),r(148,164),r(153,170),r(158,176),r(160,178),r(164,183),r(168,188),r(171,191),r(175,196),r(178,200),r(180,202),r(181,205),r(184,208),r(186,210),r(187,213),r(188,215),r(186,212),r(183,211),r(177,208),r(169,206),r(162,205),r(154,207),r(145,209),r(137,210),r(129,214),r(122,217),r(118,218),r(111,221),r(109,222),r(110,219),r(112,217),r(118,209),r(120,207),r(128,196),r(135,187),r(138,183),r(148,167),r(157,153),r(163,145),r(165,142),r(172,133),r(177,127),r(179,127),r(180,125)])),this.Templates.push(new s("star",[r(75,250),r(75,247),r(77,244),r(78,242),r(79,239),r(80,237),r(82,234),r(82,232),r(84,229),r(85,225),r(87,222),r(88,219),r(89,216),r(91,212),r(92,208),r(94,204),r(95,201),r(96,196),r(97,194),r(98,191),r(100,185),r(102,178),r(104,173),r(104,171),r(105,164),r(106,158),r(107,156),r(107,152),r(108,145),r(109,141),r(110,139),r(112,133),r(113,131),r(116,127),r(117,125),r(119,122),r(121,121),r(123,120),r(125,122),r(125,125),r(127,130),r(128,133),r(131,143),r(136,153),r(140,163),r(144,172),r(145,175),r(151,189),r(156,201),r(161,213),r(166,225),r(169,233),r(171,236),r(174,243),r(177,247),r(178,249),r(179,251),r(180,253),r(180,255),r(179,257),r(177,257),r(174,255),r(169,250),r(164,247),r(160,245),r(149,238),r(138,230),r(127,221),r(124,220),r(112,212),r(110,210),r(96,201),r(84,195),r(74,190),r(64,182),r(55,175),r(51,172),r(49,170),r(51,169),r(56,169),r(66,169),r(78,168),r(92,166),r(107,164),r(123,161),r(140,162),r(156,162),r(171,160),r(173,160),r(186,160),r(195,160),r(198,161),r(203,163),r(208,163),r(206,164),r(200,167),r(187,172),r(174,179),r(172,181),r(153,192),r(137,201),r(123,211),r(112,220),r(99,229),r(90,237),r(80,244),r(73,250),r(69,254),r(69,252)])),this.Templates.push(new s("pigtail",[r(81,219),r(84,218),r(86,220),r(88,220),r(90,220),r(92,219),r(95,220),r(97,219),r(99,220),r(102,218),r(105,217),r(107,216),r(110,216),r(113,214),r(116,212),r(118,210),r(121,208),r(124,205),r(126,202),r(129,199),r(132,196),r(136,191),r(139,187),r(142,182),r(144,179),r(146,174),r(148,170),r(149,168),r(151,162),r(152,160),r(152,157),r(152,155),r(152,151),r(152,149),r(152,146),r(149,142),r(148,139),r(145,137),r(141,135),r(139,135),r(134,136),r(130,140),r(128,142),r(126,145),r(122,150),r(119,158),r(117,163),r(115,170),r(114,175),r(117,184),r(120,190),r(125,199),r(129,203),r(133,208),r(138,213),r(145,215),r(155,218),r(164,219),r(166,219),r(177,219),r(182,218),r(192,216),r(196,213),r(199,212),r(201,211)])),this.Recognize=function(e){var t=+Infinity,n=0,r,i,s,u;e=h(e,a),r=p(e),e=d(e,-r),u=g(e);for(i=0;i<this.Templates.length;i++){var f=y(this.Templates[i].Vector,u);f<t&&(t=f,n=i)}return new o(this.Templates[n].Name,1/t)}}function h(e,t){var n=E(e)/(t-1),i=0,s=new Array(e[0]),o;for(o=1;o<e.length;o++){var u=S(e[o-1],e[o]);if(i+u>=n){var a=e[o-1].X+(n-i)/u*(e[o].X-e[o-1].X),f=e[o-1].Y+(n-i)/u*(e[o].Y-e[o-1].Y),l=r(a,f);s[s.length]=l,e.splice(o,0,l),i=0}else i+=u}return s.length==t-1&&(s[s.length]=r(e[e.length-1].X,e[e.length-1].Y)),s}function p(e){var t=b(e);return Math.atan2(t.Y-e[0].Y,t.X-e[0].X)}function d(e,t){var n=b(e),i=Math.cos(t),s=Math.sin(t),o=[],u;for(u=0;u<e.length;u++){var a=(e[u].X-n.X)*i-(e[u].Y-n.Y)*s+n.X,f=(e[u].X-n.X)*s+(e[u].Y-n.Y)*i+n.Y;o[o.length]=r(a,f)}return o}function v(e,t){var n=w(e),i=[],s;for(s=0;s<e.length;s++){var o=e[s].X*(t/n.Width),u=e[s].Y*(t/n.Height);i[i.length]=r(o,u)}return i}function m(e,t){var n=b(e),i=[],s;for(s=0;s<e.length;s++){var o=e[s].X+t.X-n.X,u=e[s].Y+t.Y-n.Y;i[i.length]=r(o,u)}return i}function g(e){var t=0,n=[],r,i;for(r=0;r<e.length;r++)n[n.length]=e[r].X,n[n.length]=e[r].Y,t+=e[r].X*e[r].X+e[r].Y*e[r].Y;i=Math.sqrt(t);for(r=0;r<n.length;r++)n[r]/=i;return n}function y(e,t){var n=0,r=0,i,s;for(i=0;i<e.length;i+=2)n+=e[i]*t[i]+e[i+1]*t[i+1],r+=e[i]*t[i+1]-e[i+1]*t[i];return s=Math.atan(r/n),Math.acos(n*Math.cos(s)+r*Math.sin(s))}function b(e){var t=0,n=0,i;for(i=0;i<e.length;i++)t+=e[i].X,n+=e[i].Y;return t/=e.length,n/=e.length,r(t,n)}function w(e){var t=+Infinity,n=-Infinity,r=+Infinity,s=-Infinity,o;for(o=0;o<e.length;o++)e[o].X<t&&(t=e[o].X),e[o].X>n&&(n=e[o].X),e[o].Y<r&&(r=e[o].Y),e[o].Y>s&&(s=e[o].Y);return new i(t,r,n-t,s-r)}function E(e){var t=0,n;for(n=1;n<e.length;n++)t+=S(e[n-1],e[n]);return t}function S(e,t){var n=t.X-e.X,r=t.Y-e.Y;return Math.sqrt(n*n+r*r)}e.fn.motionCaptcha=function(n){return this.each(function(){function T(e){var t,n;return e.touches&&e.touches.length>0?(t=e.touches[0].pageX-l.offset().left+d,n=e.touches[0].pageY-l.offset().top+v):e.offsetX?(t=e.offsetX-d,n=e.offsetY-v):(t=e.pageX-l.offset().left-d,n=e.pageY-l.offset().top-v),[t,n]}var i=e.extend({},e.fn.motionCaptcha.defaults,n);i.actionId="#"+i.actionId.replace(/\#/g,""),i.canvasId="#"+i.canvasId.replace(/\#/g,""),i.divId="#"+i.divId.replace(/\#/g,""),i.submitId=i.submitId?"#"+i.submitId.replace(/\#/g,""):!1;var s,o=!1,u=e("body"),a=e(this),f=e(i.divId),l=e(i.canvasId),h=l.width(),p=l.height(),d=1*l.css("borderLeftWidth").replace("px",""),v=1*l.css("borderTopWidth").replace("px","");l[0].width=h,l[0].height=p;var m=l[0].getContext("2d");m.canvasWidth=h,m.canvasHeight=p,m.font=i.canvasFont,m.fillStyle=i.canvasTextColor,l.addClass(i.shapes[Math.floor(Math.random()*i.shapes.length)]);var g=!1,y=!1,b=[],w=new c;s=new t(m);var E=function(t){if(o)return!1;t.preventDefault();var n=T(t),i=n[0],u=n[1];return g=!0,y=!0,e("body").addClass("mc-noselect"),m.clearRect(0,0,h,p),s.strokeStart(i,u),l.removeClass("mc-invalid mc-valid"),b=[r(i,u)],!1},S=function(e){if(y)return y=0;if(!o&&g){e.preventDefault();var t=T(e),n=t[0],i=t[1];b[b.length]=r(n,i),s.stroke(n,i)}return!1},x=function(t){if(!o&&g){g=!1,e("body").removeClass("mc-noselect");if(b.length>=10){var n=w.Recognize(b);l.attr("class").match(n.Name)&&n.Score>.7?(o=1,setTimeout(s.destroy,500),l.addClass("mc-valid"),m.fillText(i.successMsg,10,24),i.onSuccess(a,l,m)):(l.addClass("mc-invalid"),m.fillText(i.errorMsg,10,24),i.onError(a,l,m))}else l.addClass("mc-invalid"),m.fillText(i.errorMsg,10,24),i.onError(a,l,m)}return!1};l.bind({mousedown:E,mousemove:S,mouseup:x}),l[0].addEventListener("touchstart",E,!1),l[0].addEventListener("touchmove",S,!1),l[0].addEventListener("touchend",x,!1),a.addClass(i.cssClass.replace(/\./,""))})},e.fn.motionCaptcha.defaults={actionId:"#mc-action",divId:"#mc",canvasId:"#mc-canvas",submitId:!1,cssClass:".mc-active",shapes:["triangle","x","rectangle","circle","check","caret","zigzag","arrow","leftbracket","rightbracket","v","delete","star","pigtail"],canvasFont:'15px "Lucida Grande"',canvasTextColor:"#111",errorMsg:"Please try again.",successMsg:"Captcha passed!",noCanvasMsg:"Your browser doesn't support <canvas> - try Chrome, FF4, Safari or IE9.",label:"<p>Please draw the shape in the box to submit the form:</p>",onSuccess:function(t,n,r){var i=this,s=i.submitId?t.find(i.submitId):t.find("input[type=submit]:disabled");t.attr("action",e(i.actionId).val()),s.prop("disabled",!1);return},onError:function(e,t,n){var r=this;return}},t.prototype={ctx:null,X:null,Y:null,painters:null,interval:null,init:function(e){function o(){var e;t.ctx.lineWidth=r,t.ctx.strokeStyle="rgba("+i[0]+", "+i[1]+", "+i[2]+", "+.06+")";for(e=0;e<t.painters.length;e++)t.ctx.beginPath(),t.ctx.moveTo(t.painters[e].dx,t.painters[e].dy),t.painters[e].dx-=t.painters[e].ax=(t.painters[e].ax+(t.painters[e].dx-t.X)*t.painters[e].div)*t.painters[e].ease,t.painters[e].dy-=t.painters[e].ay=(t.painters[e].ay+(t.painters[e].dy-t.Y)*t.painters[e].div)*t.painters[e].ease,t.ctx.lineTo(t.painters[e].dx,t.painters[e].dy),t.ctx.stroke()}var t=this,n=navigator.userAgent.toLowerCase(),r=n.search("android")>-1||n.search("iphone")>-1?2:1,i=[0,0,0];this.ctx=e,this.ctx.globalCompositeOperation="source-over",this.X=this.ctx.canvasWidth/2,this.Y=this.ctx.canvasHeight/2,this.painters=[];for(var s=0;s<38;s++)this.painters.push({dx:this.ctx.canvasWidth/2,dy:this.ctx.canvasHeight/2,ax:0,ay:0,div:.1,ease:Math.random()*.18+.6});this.interval=setInterval(o,1e3/60)},destroy:function(){clearInterval(this.interval)},strokeStart:function(e,t){this.X=e,this.Y=t;for(var n=0;n<this.painters.length;n++)this.painters[n].dx=e,this.painters[n].dy=t;this.shouldDraw=!0},stroke:function(e,t){this.X=e,this.Y=t}};var u=16,a=64,f=250,l=r(0,0)}(jQuery);
