!function(balls){balls.account={on:[],init:function(username,pass,repass,profType){if(0==arguments.length)this.events();else if(4==arguments.length){if(!(username&&pass&&repass&&profType&&userSession.email))return balls.error("Sorry but you seem to be missing some information, please try again.","See object for information passed from user",{logObject:{Username:username,Password:pass,RePass:repass,ProfType:profType,Email:userSession.email},suppressSystem:userSession.isLive}),!1;if(!username.isValidUsername())return balls.error("Sorry but your username does not fit the requirements."),!1;if(!pass.isValidPassword())return balls.error("Your password does not fit the requirements."),!1;if(pass!=repass)return balls.error("The two passwords did not match. Please try again."),!1;$.ajax({url:"wp-content/plugins/user/api.php",type:"post",data:{action:"register",password:pass,confpass:repass,username:username,profile:profType,email:userSession.email}}).done(function(response){userSession.profileType=profType,response=$.parseJSON(response),response&&response.data?(toast.success("Account created! Welcome to Eardish!"),$.ajax({url:"/profile/"}).done(function(html){$("body").html($(html).find("body").html())})):balls.error("There was a problem initilizing your account. "+response,"Response object to follow:",{logObject:response,suppressSystem:userSession.isLive})})}},events:function(){var account=this;if($("body .credentials input").on("keyup",function(e){"13"==e.keyCode&&$("body .credentials div.button").click()}),$("body .credentials div.button").on("click",function(e){e.preventDefault(),balls.account.login($("body .credentials>input[type='text']").val(),$("body .credentials>input[type='password']").val(),$("body .credentials input[name='rememberMe']:checked").val()||!1)}).on("keypress",function(e){(32===e.which||13===e.which)&&$(this).click()}),$("body").on("click","div.popupWrap>div.accInitPopup>button.submit",function(e){e.preventDefault();var wrapper=$(this.parentNode.parentNode),username=wrapper.find("input.username").val(),pass=wrapper.find("input.password").val(),repass=wrapper.find("input.passwordConfirm").val(),profType=wrapper.find("input[name='accType']:checked").val();account.init(username,pass,repass,profType)}),$("body").on("keyup","div.popupWrap div.accInitPopup>input.username",function(e){e.preventDefault(),account.keyAvail.check("checkusername","username",$(this).val())}),$("body").on("click","div.popupWrap>div.accInitPopup>span.close",function(e){e.preventDefault(),$(this.parentNode.parentNode).addClass("hidden")}),$("body").on("click","div.submitEmail>div.continue>a.showTokenField",function(){$("body div.submitEmail input").removeClass("hidden").addClass("two"),$("body div.submitEmail div.getStarted img").attr("src","http://"+userSession.cdn+"/images/helloCircle.png"),$("body div.submitEmail div.button").removeClass("button").addClass("button2"),$("body div.submitEmail div.button2 img").attr("src","http://"+userSession.cdn+"/images/goButtonB.png"),$("body div.submitEmail div.continue").addClass("hidden"),$("body div.submitEmail div.noToken").removeClass("hidden")}),$("body").on("click","div.submitEmail>div.noToken>a.backToPreReg",function(){$("body div.submitEmail input").removeClass("two"),$("body div.submitEmail input+input").addClass("hidden"),$("body div.submitEmail div.getStarted img").attr("src","http://"+userSession.cdn+"/images/getStarted.png"),$("body div.submitEmail div.button2").removeClass("button2").addClass("button"),$("body div.submitEmail div.button img").attr("src","http://"+userSession.cdn+"/images/goButtonA.png"),$("body div.submitEmail div.continue").removeClass("hidden"),$("body div.submitEmail div.noToken").addClass("hidden")}),$("body").on("click","div.submitEmail>div.button",function(e){e.preventDefault(),account.preReg($(this.parentNode).find("input").first().val())}),$("body").on("click","div.submitEmail>div.button2",function(e){e.preventDefault();var wrapper=$(this.parentNode);account.validateReg(wrapper.find("input[name='email']").val(),wrapper.find("input[name='token']").val())}),$("body").on("keyup","div.submitEmail input[type='text']",function(e){e.preventDefault(),"13"==e.keyCode&&$(".submitEmail div.button, submitEmail, div.button2").click()}),$("body .submitEmail .button, body .submitEmail .button2").on("mouseover mouseout",function(e){var img=$(this).find("img"),src=img.attr("src");src.search("sent")<0&&(e.preventDefault(),img.attr("src","mouseover"==e.type?src.replace(/\.png/g,"-hover.png"):src.replace(/\-hover/g,"")))}),userSession.forgotToken&&""!==userSession.forgotToken)try{account.forgotPassword()}catch(e){balls.error("","Error in account.forgotPassword",{logObject:{e:e},suppressSystem:userSession.isLive})}$("body").on("click",".credentials .forgotPass a",function(e){try{account.forgotPassword()}catch(e){balls.error("","Error in account.forgotPassword",{logObject:{e:e},suppressSystem:userSession.isLive})}}),$("body").on("mouseenter mouseleave",".credentials .forgotPass",function(e){"mouseenter"===e.type?$(this).find(".tooltip").removeClass("hidden"):"mouseleave"===e.type&&$(this).find(".tooltip").addClass("hidden")}),$("body").on("click",".credentials .forgotPass .tooltip .close",function(){$(this.parentNode).addClass("hidden")})},forgotPassword:function(){var account=this,validToken=function(str){return"string"==typeof str?32===str.length:!1},autoPopulateModal=function(){var email=document.querySelector(".modalWrapper .modal .forgotPass div input#fpEmail"),token=document.querySelector(".modalWrapper .modal .forgotPass div input#fpToken"),userName=document.querySelector("body .credentials input#username");return email&&userSession.email.isValidEmail()?(email.value=userSession.email,email.setAttribute("disabled","disabled"),email.previousElementSibling.innerHTML="You will receive a token at this address:"):userName&&email&&userName.value&&userName.value.isValidEmail()&&(email.value=userName.value),token&&validToken(userSession.forgotToken)?(token.value=userSession.forgotToken,$(".modalWrapper .modal .forgotPass div a.next.token").click(),!0):(""===email.value&&""===token.value&&$(email).focus(),void 0)};if(account.on.forgotPassword||($("body").on("keyup",".modalWrapper .modal .forgotPass div input",function(e){var target=e.target,send=$(".modalWrapper .modal .forgotPass div button.send"),link=$(".modalWrapper .modal .forgotPass div a.next"),email=$(".modalWrapper .modal .forgotPass div input#fpEmail"),token=$(".modalWrapper .modal .forgotPass div input#fpToken");/fpEmail|fpToken/.test(target.id)&&this.value&&/ /.test(this.value)&&(this.value=this.value.trim()),13===e.which&&"fpEmail"===target.id&&target.value.isValidEmail()?send.click():/fpEmail|fpToken/.test(target.id)&&email[0].value.isValidEmail()&&validToken(token[0].value)&&link.hasClass("pass")&&(link.click(),target.parentNode.previousElementSibling.innerHTML="Please fill in the password fields to finish and set your password.")}),$("body").on("click",".modalWrapper .modal .forgotPass div .cancel",function(){$(this.parentNode.parentNode).find("button.close").click()}),$("body").on("click",".modalWrapper .modal .forgotPass div a.next",function(){var self=$(this),selector=".modalWrapper .modal .forgotPass div label[for=ID]";self.hasClass("token")?($(selector.replace("ID","fpToken")).removeClass("hidden").next().removeClass("hidden"),self.removeClass("token").addClass("pass"),self[0].innerHTML="Show Password Fields"):self.hasClass("pass")?($(selector.replace("ID","fpNewPass")).removeClass("hidden").next().removeClass("hidden").next().removeClass("hidden").next().removeClass("hidden"),self.removeClass("pass").addClass("reset"),self[0].innerHTML="Reset Form"):self.hasClass("reset")&&($(selector.replace("ID","fpEmail")).siblings("label, input:not([id=fpEmail])").addClass("hidden"),$(selector.replace("ID","fpEmail")).siblings("input:not([disabled])").val(""),self.removeClass("reset").addClass("token"),self[0].innerHTML="Already have a token?")}),$("body").on("transitionend webkitTransitionEnd oTransitionEnd",".modalWrapper .modal .forgotPass div",function(){$(this).find("input").each(function(){return""===this.value?($(this).focus(),!1):void 0})}),$("body").on("click",".modalWrapper .modal .forgotPass div .send",function(e){var self=this,link=$(self).siblings("a.next"),parent=$(e.target.parentNode),email=parent.find("#fpEmail")[0].value,token=parent.find("#fpToken")[0].value,newPass=parent.find("#fpNewPass")[0].value,confPass=parent.find("#fpConfPass")[0].value;return email&&token&&newPass&&confPass&&email.isValidEmail()&&validToken(token)&&newPass.isValidPassword()&&confPass.isValidPassword()&&newPass===confPass?(account.changePassword(token,newPass,confPass,email,function(){}),!0):email&&email.isValidEmail()&&""===token&&""===newPass&&""===confPass?(account.requestForgotToken(email),0!==userSession.id?!0:(link.hasClass("token")&&link.click(),self.parentNode.previousElementSibling.innerHTML="Now Paste the token from the email you received to continue.",!0)):(email&&email.isValidEmail()?token&&validToken(token)?newPass&&newPass.isValidPassword()?confPass&&confPass.isValidPassword()?newPass&&confPass&&newPass!==confPass&&balls.error("It appears the password fields don't match, please try again.","NewPass !== ConfPass",{logObject:{newPass:newPass,confPass:confPass},suppressSystem:userSession.isLive}):balls.error("The second password doesn't appear to match the requirements, please try again","ConfPass did not pass valid password test",{logObject:{confPass:newPass},suppressSystem:userSession.isLive}):balls.error("The first password doesn't appear to match the requirements, please try again","NewPass did not pass valid password test",{logObject:{newPass:newPass},suppressSystem:userSession.isLive}):balls.error("The token doesn't appear to be the correct length, did you add any extra spaces by accident?","Token did not pass valid token test",{logObject:{token:token},suppressSystem:userSession.isLive}):balls.error("I'm sorry but that doesn't look like the correct email address","Email did not pass valid email test",{logObject:{email:email},suppressSystem:userSession.isLive}),!1)}),account.on.forgotPassword=!0),userSession&&0===userSession.id&&document.querySelector("body .credentials")){var html=document.querySelector("body .credentials .forgotPass .hidden .forgotPass").cloneNode(!0);require(["balls.modal"],function(){balls.modal.html(html).style.marginTop="-400px",autoPopulateModal()})}else $.ajax({url:balls.api,data:{action:"template","post-type":"account",template:"forgotPassword",content:""},type:"post"}).done(function(res){if(res){try{res=$.parseJSON(res)}catch(e){balls.error("","boo json",{logObject:{e:e,res:res},suppressSystem:userSession.isLive})}res.html&&require(["balls.modal"],function(){balls.modal.html(res.html).style.marginTop="-400px",autoPopulateModal()})}}).fail(function(res){balls.error("Unable to obtain forgot password dialog, please try again","Failed API call on account.forgotPassword",{logObject:{response:res},suppressSystem:userSession.isLive})})},settings:function(){var account=this,openPopup=function(className){if(className&&"string"!=typeof className)return!1;var popups=document.querySelector("body section div.popups"),toOpen=popups.querySelector("."+className);popups&&toOpen&&($(toOpen).removeClass("hidden").siblings().addClass("hidden"),$(popups).removeClass("hidden"))},closePopups=function(){$("body > section > div.popups").addClass("hidden").children().addClass("hidden")};return 32===userSession.forgotToken.length&&account.forgotPassword(),require(["chosen"],function(){$("body section[id*='settings'] .profVisibility .options select").chosen({disable_search:!0,allow_single_deselect:!1}),$("body section section.language .options select").chosen({disable_search:!0,allow_single_deselect:!1}),$("body section .popups .privacyList .blockList").chosen({no_results_text:"No Members Found :("})}),account.on.settings?!0:($("body").on("click",'section[id*="settings"] > section .help .helpBtn',function(e){e.preventDefault();var parent=$(this).parent();return parent.hasClass("hidden")?(parent.parent().parent().find("div.help:not(.hidden)").addClass("hidden"),parent.removeClass("hidden")):parent.addClass("hidden"),!1}),$("body").on("change",".profVisibility .options select",function(){var option=$(this).find(":selected").val(),self=this;account.changeSetting("profile_visibility",option,function(ok,setTo,fail){if(ok){switch(setTo){case"public":setTo="Everyone";break;case"network":setTo="My Network";break;case"extended":setTo="Extended Network";break;case"private":setTo="Private";break;default:setTo=":-/"}toast.success("Profile Visibility changed to: "+setTo)}else $(self).find(":selected")[0].selected=!1,$(self).find("[value="+setTo+"]")[0].selected=!0,$(self).trigger("liszt:updated"),fail||balls.error("There was an error, Profile Visiblity could not be saved. Please try again.")})}),$("body").on("click",".blockList .options p .openBlockList",function(e){e.preventDefault(),e.stopPropagation();try{openPopup("privacyList")}catch(e){balls.error("Woha, what happened? How did you do that?","Exception on openPopup in open block list",{logObject:e,suppressSystem:userSession.isLive})}}),$("body").on("click","section .popups .privacyList .close, section .popups .privacyList .buttons .cancel",function(){closePopups();var i,popup=$(this).closest(".privacyList"),oldList=""!==popup.find("var").html()?popup.find("var").html().split(","):null;if(popup.find("select option:selected").removeAttr("selected"),null!==oldList)for(i=0;i<oldList.length;i++)popup.find("select option[value="+oldList[i]+"]")[0].selected=!0;popup.find("select").trigger("liszt:updated")}),$("body").on("click",".popups .privacyList .buttons .save",function(){var list="";$(this).parent().parent().find(":selected").each(function(){list+=$(this).val()+","}),list=list.substring(0,list.length-1),account.changeSetting("block_list",list,function(ok,setTo,fail){if(null==ok||null==setTo)return!1;if(ok)toast.success("Block list updated!"),$(".popups .privacyList var").html(setTo.toString());else{var i,selected=$(".popups .privacyList select :selected");for(i=0;i<selected.length;i++)-1==setTo.search(selected[i].getAttribute("value"))&&selected[i].removeAttribute("selected");fail||(-1!=list.search(setTo)?toast.info("There were no changes to block list."):balls.error("Block list was not updated, please try again."))}}),$("body section .popups, body section .popups .privacyList").addClass("hidden")}),$("body").on("click",".allowComments .options input[type=checkbox]",function(){var self=this,setting=self.value;account.changeSetting("comments_"+setting,$(self).is(":checked"),function(ok,setTo,fail){setTo="string"==typeof setTo?"true"===setTo:setTo,ok?toast.success("Comments are now"+(setTo?"":" not")+" allowed on "+("song"==setting?"music":setting+"s")):(self.checked=setTo,fail||balls.error("Couldn't save comments setting, please try again"))})}),$("body").on("click",".emailNotifications .options input[type=checkbox]",function(){var self=this,setting=self.value;account.changeSetting("email_"+setting,$(self).is(":checked"),function(ok,setTo,fail){if(setTo="string"==typeof setTo?"true"===setTo:setTo,ok){switch(setting){case"note":setting="notes";break;case"msg":setting="messages";break;default:setting="that thing you clicked"}toast.success("You will "+(setTo?"now":"no longer")+" receive email notifications for "+setting)}else self.checked=setTo,fail||balls.error("Couldn't save email notification setting, please try again.")})}),$("body").on("click",".changePassword .options a.forgotPass",function(e){try{balls.modal.confirm("This action will sign you out, are you sure you want to proceed?",function(ok){ok&&account.forgotPassword()})}catch(e){balls.error("","Error in account.forgotPassword",{logObject:{e:e},suppressSystem:userSession.isLive})}}),$("body").on("mouseenter mouseleave",".changePassword .options a.forgotPass",function(e){var tt=$(this).prev();"mouseenter"===e.type?tt.removeClass("hidden"):"mouseleave"===e.type&&tt.addClass("hidden")}),$("body").on("click",".changePassword .options .tooltip .close",function(){$(this.parentNode).addClass("hidden")}),$("body").on("click",".changePassword .options .submitPass",function(){var self=$(this),currPass=self.parent().find(".currPass")[0].value,newPass=self.parent().find(".newPass").val(),confirmPass=self.parent().find(".confirmNewPass").val();if(""===currPass||""===newPass||""===confirmPass)switch(toast.info("C'mon! You didn't even fill all the boxes in!"),""){case currPass:return self.parent().find(".currPass").focus(),void 0;case newPass:return self.parent().find(".newPass").focus(),void 0;case confirmPass:return self.parent().find(".confirmNewPass").focus(),void 0;default:return}account.changePassword(currPass,newPass,confirmPass,function(response){response.data===!0&&self.parent().find("input[type=password], input[type=text]").val("")})}),$("body").on("keypress",".changePassword .options input[type=password]",function(e){if(13===e.which){var submit=$(e.target).siblings("button.submitPass"),next=$(e.target).next(),check=!0;$(e.target.parentNode).children("input[type=password]").each(function(){check&&this.value&&this.value.length>0||(check=!1)}),check||next.is("button")?submit.click():next.focus()}}),this.on.settings=!0)},changeSetting:function(setting,value,cb){return null==setting||null==value?!1:($.ajax({url:"/wp-content/plugins/user/api.php",data:{action:"update",setting:setting,data:value},type:"post"}).done(function(response){response=$.parseJSON(response),response&&response.data.result===!0?cb&&"function"==typeof cb?cb(response.data.result,response.data.value):toast.success("Setting Saved!"):cb&&"function"==typeof cb?cb(response.data.result,response.data.value):toast.success("Setting could not be saved, please try again.")}).fail(function(response){balls.error("Bad Request, please try again later.","Response object to follow",{logObject:response,suppressSystem:userSession.isLive}),cb&&"function"==typeof cb&&cb(!1,value,!0)}),void 0)},requestForgotToken:function(email){return"string"==typeof email&&""!==email&&email.isValidEmail()?($.ajax({url:"/wp-content/plugins/user/api.php",data:{action:"forgotpass",email:email},type:"post"}).done(function(response){try{response=$.parseJSON(response)}catch(e){balls.error("","Exception on JSON parse in account.requestForgotToken",{logObject:{response:response,e:e},suppressSystem:userSession.isLive})}response&&response.data===!0?(toast.success("Password reset email sent! Go check your inbox."),0!==userSession.id&&balls.account.logout()):balls.error("We had some trouble requesting a token for "+email+". Are you sure this is the correct email address?","Bad response in request token.",{logObject:response,suppressSystem:userSession.isLive})}).fail(function(response){balls.error("Trouble requesting password reset, please try again.","Response object to follow",{logObject:{response:response},suppressSystem:userSession.isLive})}),void 0):!1},changePassword:function(oldPass,newPass,confPass,email,cb){if("function"==typeof email&&null==cb&&(cb=email,email=null),null==oldPass||null==newPass||null==confPass)return cb&&"function"==typeof cb&&cb(!1),!1;if(newPass!==confPass)return balls.error("New password and confirmation don't match!","Incorrect inputs in change password",{suppressSystem:userSession.isLive}),cb&&"function"==typeof cb&&cb(!1),!1;if(!newPass.isValidPassword())return balls.error("New Password does not conform to the password requirements!","Incorrect inputs in change password",{suppressSystem:userSession.isLive}),cb&&"function"==typeof cb&&cb(!1),!1;var data={action:"resetpass",oldpass:oldPass,password:newPass,confpass:confPass};email&&email.isValidEmail()&&(data.email=email),$.ajax({url:"/wp-content/plugins/user/api.php",data:data,type:"post"}).done(function(response){response=$.parseJSON(response),response&&response.data===!0?(toast.success("Password successfully changed! We will now log you back in with your new password...",{longToast:!0}),email?balls.account.login(email,newPass,!0,"/account/settings/"):balls.account.login(userSession.email,newPass,!0,!0)):balls.error("Password was not updated. Please try again"),cb&&"function"==typeof cb&&cb(response)}).fail(function(response){balls.error("Password could not be changed, please try again later","Response to follow",{logObject:response,suppressSystem:userSession.isLive}),cb&&"function"==typeof cb&&cb(response)})},preReg:function(email){return null==email||""==email||0==email.isValidEmail()?!1:($.ajax({url:"/wp-content/plugins/user/api.php",data:{email:email,action:"prereg"},type:"post"}).done(function(response){response=$.parseJSON(response),response&&response.data?"exists"==response.data?toast.info("The email you provided is already in the system, did you forget your password?"):($("body .submitEmail .button img").attr("src","http://"+userSession.cdn+"/images/sentA.png"),$("body .submitEmail input[type='text']").val("").attr("disabled","disabled"),$("body .submitEmail input").attr("placeholder","Thank you for joining the evolution!"),$("body .submitEmail .getStarted img").attr("src","http://"+userSession.cdn+"/images/thankYou.png"),toast.success("Thank your for your intrest in Eardish. We hope to send you an invite token shortly!")):balls.error("The email you provided did not pass the requirements, please try again.")}).fail(function(response){balls.error("Something went wrong :( Please try again.","Failed API call in account.preReg, response to follow",{logObject:response,suppressSystem:userSession.isLive})}),void 0)},validateReg:function(email,token){email&&email.isValidEmail()&&token&&$.ajax({url:"/wp-content/plugins/user/api.php",type:"post",data:{action:"validatereg",token:token,email:email}}).done(function(response){response&&(userSession.email=email,toast.success("Valid token! Welcome to Eardish!"),$("body>div.popupWrap").removeClass("hidden"))})},setPassword:function(){var old=3==arguments.length&&arguments[0]?arguments[0]:null,pass=arguments[1]?arguments[1]:null,repass=arguments[2]?arguments[2]:null,newPass=(arguments[3]?arguments[3]:null,pass==repass?pass:null);return null!=newPass&&newPass.isValidPassword()?($.ajax({url:"/wp-content/plugins/user/api.php",type:"post",data:{action:"resetpass",oldpass:old,password:newPass,confpass:repass}}).done(function(response){var response=arguments[0]?$.parseJSON(arguments[0]):null;try{response.error?balls.error(response.error.msg):($(".setPassword").addClass("hidden"),toast.success("Password set!"),old||(window.location=window.location.href))}catch(e){balls.error("","Exception caught in account.setPassword",{logObject:{e:e,stackTrace:e.stackTrace},suppressSystem:userSession.isLive})}}).fail(function(response){balls.error("Failed to set password, please try again.","Failed API call:",{logObject:response,suppressSystem:userSession.isLive})}),!0):(balls.error("Error: Passwords don't match the requirements or they differ!","Pass: "+pass+" - RePass: "+repass,{suppressSystem:userSession.isLive}),!1)},keyAvail:{activelyChecking:[],check:function(action,key,val){if(null==action||null==key||null==val)return!1;var data={};data.action=action,data[key]=val,null!=balls.account.keyAvail.activelyChecking[key]&&balls.account.keyAvail.activelyChecking[key].abort(),balls.account.keyAvail.activelyChecking[key]=$.ajax({url:"/wp-content/plugins/user/api.php",type:"post",data:data}).done(function(response){response&&(response=$.parseJSON(response),$("body>div.popupWrap>div.accInitPopup>input."+key).removeClass("red").removeClass("green").addClass(1==response.data||""==val||null==val?"red":"green"),(1==response.data||""==val||null==val)&&balls.error("We're sorry, "+key+" is already in use.")),balls.account.keyAvail.activelyChecking[key]=null})}},login:function(email,password,remember,navigateTo){return email&&password?($.ajax({url:"/wp-content/plugins/user/api.php",type:"post",data:{action:"login",email:email,password:password,remember:remember}}).done(function(response){return response=$.parseJSON(response),response&&response.data&&response.data.ID?navigateTo===!0?(toast.success("Login Successful! Now go about your business.",{className:"login"}),!0):navigateTo&&"string"==typeof navigateTo?(window.location.replace(navigateTo),!0):(toast.success("Login Successful! Hang on while we load the awesome...",{persist:!0,className:"login"}),window.location.href="/profile/",!0):(balls.error("Login uncuccessful. "+response.data,"Unsuccessful login attempt.",{logObject:response,suppressSystem:userSession.isLive}),userSession.loginAttempts?(userSession.loginAttempts+=1,userSession.loginAttempts>2&&$("div.forgotPass.tooltip.hidden").removeClass("hidden")):userSession.loginAttempts=1,void 0)}),void 0):!1},logout:function(){toast.info("Logging out..."),$.ajax({url:"/wp-content/plugins/user/api.php",type:"post",data:{action:"logout"}}).done(function(response){response&&(window.location.href=window.location.origin||window.location.protocol+"//"+window.location.host)})}}}(window.balls);