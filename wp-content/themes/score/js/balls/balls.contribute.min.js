!function(balls){balls.contribute={get api(){return"/wp-content/plugins/contribute/api.php"},get dropZone(){return $("section.contribute .context .dropZone")},init:function(){window.contributeXHR=[],this.events()},error:function(message){var contribute=this;if(message&&"string"==typeof message)try{toast.error(message),setTimeout(function(){contribute.reset(!0)},toast.animation.getDelay())}catch(e){console.log(e),console.log(message)}},success:function(close){var contribute=this,close=close?close:!0;toast.success("Hey... cool, you've just made music happen!"),setTimeout(function(){contribute.reset(close)},1500)},reset:function(close){close=close?close:!1,$("section.contribute .dropZone .cancel").addClass("hidden"),$("section.contribute .context .songConfirm").remove(),$("section.contribute .context .photoSave").remove(),$("section.contribute .context").children().removeClass("hidden").show(),$("section.contribute .dropZone .progress").remove(),$("section.contribute .dropZone").removeClass("hover").removeClass("uploading"),close&&($("body>.drop_zone>.sortable .widgets .widget.contribute .wrapper").removeClass("open"),$("body>.drop_zone>.sortable #btn_contribute").removeClass("open")),balls.ePlayer.stop()},cancel:function(id){id&&(this.reset(!0),window.contributeXHR.hasOwnProperty(id)&&(window.contributeXHR[id].abort(),window.contributeXHR[id]=null))},remove:function(id){id&&$.ajax({url:balls.song.api,type:"post",data:{id:id,action:"delete"}}).done(function(response){response&&$("[data-content='"+id+"']").remove()})},upload:function(files,id){if(id=id?id:userSession.id,!(files.length>0))return!1;var I=0;for(I;I<files.length;I++){var name=files[I].name.toString(),fileExt=name.substring(name.lastIndexOf(".")+1,name.length),fileType=balls.file.typeAuth(fileExt,files[I].type);fileType&&this[fileType](files[I],id)}return!0},image:function(file,id){var fileName=file.name.trim().replace(/\.[^.]*$/g,"");window.contributeXHR[fileName]=balls.file.upload(file,id,"photo",function(response){var response=response?$.parseJSON(response):null,resId=response&&response.data?response.data.resource.source.resourceId:null,imageSrc=response&&response.data?response.data.resource.source.url:null;resId?$.ajax("/wp-content/themes/score/tpl/photo/contribute.php").done(function(response){$("section.contribute .dropZone, section.contribute .selectType, section.contribute p").addClass("hidden"),response&&($("section.contribute .context").prepend(response),$("section.contribute .context .photoSave .meta .image img").attr("src",imageSrc),$("section.contribute .context .photoSave .commit .save").attr("data-resId",resId))}):balls.error("","No resource ID")})},completeImage:function(resId,caption){return null==resId?!1:(window.contributeXHR[resId]=$.ajax({url:balls.contribute.api,type:"POST",data:{action:"setphoto",id:resId,caption:caption}}).done(function(data){var src=data?data:null;return src?(toast&&toast.success("image uploaded"),balls.contribute.reset(),void 0):!1}),void 0)},completeSong:function(postId,newStatus,close){var contribute=this;postId&&newStatus&&(newStatus=newStatus.split("+")[0],$.ajax({url:balls.contribute.api,type:"POST",data:{action:"confirm",typeid:postId,status:newStatus}}).done(function(response){response&&(contribute.success(close),toast.success("Your upload: "+newStatus+"~ing!"),balls.playlist.song.add({origin:$("section.contribute .context .songConfirm[data-content='"+postId+"'] .commit input[type='button'][name='save']")}))}))},audio:function(file,id){var contribute=this,fileName=file.name.trim().replace(/\.[^.]*$/g,"");$("section.contribute .dropZone .cancel").attr("data-src",fileName).removeClass("hidden"),window.contributeXHR[fileName]=balls.file.upload(file,id,"song",function(response){if(response){var response=response?$.parseJSON(response):null,duration=response&&response.data?response.data.resource.source.duration:null,resId=response&&response.data?response.data.resource.source.songid:null,wfid=response&&response.data?response.data.resource.source.wfid:null;if(response.status&&response.status.code>"29")return balls.contribute.error("Error:"+response.status.code+" - "+response.status.message),console.log("Error: "+response.status.code+" - "+response.status.message),!1;if(response===!1||null==response||null==wfid||null==resId)return!1;"data"!=response.data.resource.type||null==resId||window.contributeXHR[resId]||(window.contributeXHR[resId]=$.ajax({url:balls.api,type:"POST",data:{template:"contribute","post-type":"song",id:resId,duration:duration}}).done(function(data){$("section.contribute .dropZone .cancel").attr("data-src","").addClass("hidden");var data=data?$.parseJSON(data):null,html=data?data.html:null;html&&""!=html&&"\n"!=html?($("section.contribute .context").children().hide(),$("section.contribute .context").prepend(html),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .theClip .slideContainer img").attr("src",response.data.resource.source.png).attr("data-wfid",wfid),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .commit input[type='button'][name='save']").attr("data-resource",resId).attr("data-start",contribute.setStartTime(resId)).attr("data-length",contribute.setDemoSelector(resId)),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .complete .full img").attr("src",response.data.resource.source.png),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .playFull").attr("data-audio",response.data.resource.source.song),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .playDemo").attr("data-audio",response.data.resource.source.song),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .meta select").chosen({disable_search:!0}),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .slideContainer .selector").draggable({axis:"x",revert:!1,scroll:!1,containment:"parent"}),$("section.contribute .context .songConfirm[data-content='"+resId+"'] .slideContainer").droppable().on("drop",function(){var start=contribute.setStartTime($(this).find(".selector")[0]);$(this).parent().parent().find(".commit").find("input[name='save']").attr("data-start",start)})):balls.error("There seems to be a problem with the conribute widget... ut ohh.")}).fail(function(response){response&&balls.error("",response)}))}return!1})},albumArt:function(file,id){var contribute=this;contribute.dropZone.show(),console.log(file.name.trim()),window.contributeXHR[file.name.trim()]=balls.file.upload(file,id,"song",function(response){contribute.dropZone.hide();var complete,response=response?$.parseJSON(response):null;return response&&(complete=$("section.contribute .context .songConfirm[data-content='"+id+"']").find(".complete"),complete.removeClass("hidden").siblings().addClass("hidden"),complete.children("img").attr("src",response.data.resource.source)),!1})},setDemoSelector:function(id,time){var ratio,width,container=$("section.contribute .context .songConfirm[data-content='"+id+"'] .slideContainer"),selector=container.find(".selector"),time=time?parseInt(time,10):60,songLength=selector.attr("data-length").split(":");return id&&time?(songLength=songLength[1]?60*parseInt(songLength[0],10)+parseInt(songLength[1],10):parseInt(songLength[0],10),ratio=time/songLength,width=Math.floor(parseInt(container[0].offsetWidth,10)*ratio)+"px",selector.css("width",width),container.parent().parent().parent().find(".commit input[name='save']").attr("data-length",time),time):void 0},setStartTime:function(){var songLength,leftOffset,startTime,width,selector=arguments[0]&&"string"!=typeof arguments[0]&&"number"!=typeof arguments[0]?$(arguments[0]):null;return selector=null!=selector||"string"!=typeof arguments[0]&&"number"!=typeof arguments[0]?selector:$("section.contribute .context .songConfirm[data-content='"+arguments[0]+"'] .slideContainer .selector"),selector[0]?(songLength=selector.attr("data-length")&&""!=selector.attr("data-length")?selector.attr("data-length").split(":"):0,songLength=songLength[1]?60*parseInt(songLength[0],10)+parseInt(songLength[1],10):parseInt(songLength[0],10),leftOffset=selector[0].style.left.split("px")[0],width=selector.parent()[0].offsetWidth,startTime=songLength?Math.floor(songLength*leftOffset/width):0):!1},events:function(){var contribute=this;$(document).on("dragover dragleave drop",function(e){e.returnValue=!1,e.preventDefault();var self=$("body").find("#the_contribute"),btn=self.parent().parent().next().find("#btn_contribute");"dragover"===e.type?(self.addClass("open"),self.find(".dropZone").addClass(self.find(".dropZone").hasClass("hover")?"":"hover"),btn.hasClass("open")===!1&&btn.addClass("open")):"dragleave"===e.type&&(self.removeClass("open"),self.find(".dropZone").removeClass("hover"),"drop"!==e.type&&btn.hasClass("open")&&btn.removeClass("open"))}),$("section.contribute").on("drop",".dropZone",function(e){e.preventDefault(),e.stopPropagation(),$(this).removeClass("hover").addClass("uploading"),contribute.upload(e.originalEvent.dataTransfer.files)}),$("section.contribute .dropZone .cancel").on("click",function(){var self=$(this);contribute.cancel(self.attr("data-src"))}),$("section.contribute").on("click",".dropZone",function(){$("section.contribute .song input[type='file']")[0].click()}),$("section.contribute").on("change",".song input[type='file']",function(){contribute.upload(this.files),$("section.contribute .song input[type='file']").val("")}),$("section.contribute").on("click",".photoSave .commit .save",function(e){e.stopPropagation(),contribute.completeImage($(this).attr("data-resId"),$(this).parent().parent().find("[name='caption']").val())}),$("section.contribute").on("click",".photoSave .commit .cancel",function(e){e.stopPropagation(),contribute.reset(!0)}),$("section.contribute").on("click","div.btn#btn_contribute, div.widgetClose",function(){contribute.reset(!0),balls.ePlayer.stop()}),$("section.contribute").on("click",".context .timeSelect input[type='radio']",function(){var id=$(this).parent().parent().parent().attr("data-content");switch($(this).attr("class")){case"sixtySec":contribute.setDemoSelector(id,60);break;case"nintySec":contribute.setDemoSelector(id,90)}}),$("section.contribute").on("change",".context .meta select.genre",function(){var self=$(this);self.parent().next().find("input[name='save']").attr("data-genre",self.val())}),$("section.contribute").on("keyup",".context .meta input",function(e){var self=$(this);"13"===e.keyValue?self.parent().next().find("[name='save']").click():self.parent().next().find("[name='save']").attr("data-title",self.val())}),$("section.contribute").on("click",".context .songConfirm .commit input[type='button'][name='save']",function(){var self=$(this);$("section.contribute").find(".dropZone").show(),$.ajax({url:balls.contribute.api,type:"POST",data:{action:"set",title:self.attr("data-title"),genre:self.attr("data-genre"),demoStart:self.attr("data-start"),demoLength:self.attr("data-length"),mfpResourceId:self.attr("data-resource"),wfid:self.parent().parent().find(".theClip .slideContainer img").attr("data-wfid")}}).done(function(response){$("section.contribute").find(".dropZone").hide();var response=response?$.parseJSON(response):null,id=response.id,wrapper=self.parent().parent(),complete=wrapper.find(".complete"),mfp=response.mfp;return null==id?!1:(toast.success("Song demo clipping complete."),wrapper.attr("data-content",id).children().each(function(){var child=$(this);child.hasClass("albumArt")?child.removeClass("hidden"):child.addClass("hidden")}),complete.find(".artist").html(userSession.name),complete.find(".title").html(self.attr("data-title")),complete.find(".genre").append(response.genre),complete.find(".length").append(self.parent().parent().find(".theClip .slideContainer .selector").attr("data-length").toHHMMSS()),complete.find(".demo img").attr("src",mfp.data.resource.source.png),wrapper.find(".playDemo").each(function(){$(this).attr("data-audio",mfp.data.resource.source.song)}),self.attr("data-start",0),self.attr("data-length",0),void 0)}).fail(function(response){balls.error("",response)})}),$("section.contribute").on("dragover dragleave drop",".context .albumArt .dropArea",function(e){var self=$(this);"dragover"===e.type||"drop"===e.type?self.addClass("highlight"):self.removeClass("highlight")}),$("section.contribute").on("drop",".context .albumArt .dropArea",function(e){e.stopPropagation(),e.preventDefault();var id=$(this).parent().parent().attr("data-content")||null;return id&&""!==id?(contribute.upload(e.originalEvent.dataTransfer.files,"albumArt",id),void 0):!1}),$("section.contribute").on("click",".context .albumArt input[name='skip']",function(){$(this).parent().parent().find(".complete").removeClass("hidden").siblings().addClass("hidden")}),$("section.contribute .song .confirm .preview").on("click","div",function(){}),$("section.contribute").on("click",".context .songConfirm .complete .publish",function(){var id=$(this).parent().parent().attr("data-content");contribute.completeSong(id,"publish"),balls.ePlayer.stop()}),$("section.contribute").on("click",".context .songConfirm .complete .publishPlus",function(){var id=$(this).parent().parent().attr("data-content");contribute.completeSong(id,"publish",!1),balls.ePlayer.stop()}),$("section.contribute").on("click",".context .songConfirm .complete .delete",function(){var id=$(this).parent().parent().attr("data-content");contribute.completeSong(id,"delete"),balls.ePlayer.stop()}),$("section.contribute").on("click",".context .songConfirm .complete .startOver",function(){var id=$(this).parent().parent().attr("data-content");contribute.completeSong(id,"delete",!1),balls.ePlayer.stop()}),$("section.contribute").on("click",".songConfirm .playFull, .songConfirm .playDemo",function(){var self=$(this),startTime=self.hasClass("playDemo")?self.parent().parent().parent().find(".commit input[name='save']").attr("data-start"):0,playTime=self.hasClass("playDemo")?self.parent().parent().parent().find(".commit input[name='save']").attr("data-length"):0;balls.ePlayer.play(self.attr("data-audio"),startTime,playTime),self.addClass("hidden"),self.siblings(".stop").removeClass("hidden")}),$("section.contribute").on("click",".songConfirm .previewUpload .stop",function(){var self=$(this);self.addClass("hidden"),self.siblings(".playDemo, .playFull").removeClass("hidden"),balls.ePlayer.stop()}),$("section.contribute").on("click",".songConfirm .complete .stop",function(){balls.ePlayer.stop(),$(this).addClass("hidden"),$(this).prev().removeClass("hidden")}),balls.ePlayer.player.addEventListener("ended",function(){$("section.contribute .playDemo, section.contribute .playFull").removeClass("hidden").next(".stop").addClass("hidden")},!1)}}}(window.balls);